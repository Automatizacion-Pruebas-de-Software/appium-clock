name: Appium Android Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 6 * * *'  # Ejecutar diariamente a las 6 AM UTC

jobs:
  appium-tests:
    name: Run Appium Android Tests
    runs-on: ubuntu-latest
    
    # Agregar variables de entorno para el emulador
    env:
      ANDROID_EMULATOR_WAIT_TIME_BEFORE_KILL: 60
    
    steps:
    # Paso 1: Checkout del cÃ³digo
    - name: Checkout repository
      uses: actions/checkout@v4

    # Paso 2: Configurar Java
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # Paso 3: Aceptar licencias Android
    - name: Accept Android Licenses
      run: |
        yes | sdkmanager --licenses || true

    # Paso 4: Crear y ejecutar emulador (CONFIGURACIÃ“N MEJORADA)
    - name: Run Android Emulator
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 34
        arch: x86_64
        profile: pixel_6
        target: google_apis
        disk-size: 4096M
        ram-size: 2048M
        emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -camera-front none -no-snapshot -memory 2048
        disable-animations: true
        script: |
          echo "ðŸ”§ Configurando emulador..."
          adb devices
          echo "â³ Esperando a que el dispositivo estÃ© listo..."
          adb wait-for-device
          echo "ðŸ“± Dispositivo detectado, esperando arranque completo..."
          # Esperar a que el sistema estÃ© completamente listo
          adb shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 2; done;'
          echo "âœ… Sistema arrancado completamente"
          adb shell settings put global window_animation_scale 0.0
          adb shell settings put global transition_animation_scale 0.0
          adb shell settings put global animator_duration_scale 0.0
          adb shell pm list packages | grep deskclock

    # Paso 5: Configurar Node.js
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: ''

    # Paso 6: Instalar Appium y dependencias
    - name: Install Appium and Python dependencies
      run: |
        npm install -g appium@next
        appium driver install uiautomator2
        appium plugin install images
        pip install appium-python-client selenium

    # Paso 7: Iniciar Appium Server
    - name: Start Appium Server
      run: |
        appium --log-level info --relaxed-security --allow-insecure=adb_shell &
        APPIUM_PID=$!
        echo "APPIUM_PID=$APPIUM_PID" >> $GITHUB_ENV
        sleep 15
        echo "ðŸš€ Appium server started"
        ps aux | grep appium

    # Paso 8: Verificar conectividad
    - name: Verify connectivity
      run: |
        echo "ðŸ” Verificando estado del emulador..."
        adb devices
        adb shell getprop sys.boot_completed
        adb shell dumpsys power | grep "mScreenOn=true" || adb shell input keyevent 26
        echo "âœ… VerificaciÃ³n completada"

    # Paso 9: Ejecutar suite de tests
    - name: Run Test Suite
      run: |
        echo "ðŸŽ¯ Iniciando ejecuciÃ³n de tests..."
        python run_test_suite.py

    # Paso 10: Subir resultados y screenshots
    - name: Upload Test Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          test-reports/
          *.png
        retention-days: 7

    # Paso 11: Limpiar procesos
    - name: Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ Limpiando procesos..."
        if [ ! -z "$APPIUM_PID" ]; then
          kill $APPIUM_PID 2>/dev/null || true
        fi
        adb emu kill || true
        echo "âœ… Cleanup completado"